var app=app||{};app.AutoResult=Backbone.Model.extend({idAttribute:"resource_id"});var app=app||{};app.Food=Backbone.Model.extend({idAttribute:"resource_id",getLogData:function(e){return e=e||{},app.kcalLog.getData({resourceId:this.get("resource_id"),startDate:e.startDate,endDate:e.endDate})},addLogEntry:function(e,t){isNaN(e)||isNaN(t.getTime())?console.error("Invalid log entry data:",e,t):app.kcalLog.create({resourceId:this.get("resource_id"),kcalCount:e,date:t})}});var app=app||{};app.LogEntry=Backbone.Model.extend({constructor:function(){arguments[0].date=app.LogEntry.getAdjustedDate(new Date(arguments[0].date)).getTime(),Backbone.Model.apply(this,arguments)},setDate:function(e){var t=app.LogEntry.getAdjustedDate(e);this.save({date:t.getTime()})},setCalorieCount:function(e){this.save({kcalCount:e})}}),app.LogEntry.getAdjustedDate=function(e){var t=new Date(e);return t.setUTCHours(0),t.setUTCMinutes(0),t.setUTCSeconds(0),t.setUTCMilliseconds(0),t.setUTCMinutes(720),t.setUTCDate(e.getDate()),t};var app=app||{},AutoResultList=Backbone.Collection.extend({model:app.AutoResult,query:"",url:function(){return"https://apibeta.nutritionix.com/v2/autocomplete/?q="+this.query+"&appId=eb3bbaeb&appKey=4c8398b6c27e2dc907348213956bc02f"},parse:function(e){return e.length?e:[]},autocomplete:function(e){e!==this.query&&""!==e&&(this.query=e,this.fetch())}});app.autoResults=new AutoResultList;var app=app||{},FoodList=Backbone.Collection.extend({model:app.Food,localStorage:new Backbone.LocalStorage("foods-backbone"),comparatorType:"item_name",reverseOrder:!1,acceptableComparatorTypes:["item_name","brand_name","nutrient_value"],changeComparatorType:function(e){this.acceptableComparatorTypes.indexOf(e)>-1&&(this.comparatorType=e,this.sort())},toggleReverseOrder:function(e){e?this.reverseOrder=!0:this.reverseOrder=!1,this.sort()},comparator:function(e,t){var a=e.get(this.comparatorType),i=t.get(this.comparatorType),s=this.reverseOrder?-1:1;return a>i?1*s:i>a?-1*s:0}});app.foods=new FoodList;var app=app||{},CalorieLog=Backbone.Collection.extend({model:app.LogEntry,localStorage:new Backbone.LocalStorage("kcal-log-backbone"),initialize:function(){this.on("change",this.sort)},select:function(e){return e=e||{},this.filter(function(t){if(e.resourceId&&t.get("resourceId")!==e.resourceId)return!1;var a=new Date(t.get("date"));return e.startDate&&a<app.LogEntry.getAdjustedDate(e.startDate)?!1:e.endDate&&a>app.LogEntry.getAdjustedDate(e.endDate)?!1:!0})},getData:function(e){var t=this.select(e),a={results:t,totalCalories:0,kcalsByDate:{}};return t.forEach(function(e){var t=new Date(e.get("date")).toDateString(),i=a.kcalsByDate,s=e.get("kcalCount");i[t]?i[t]+=s:i[t]=s,a.totalCalories+=s}),a},comparator:function(e){return-e.get("date")}});app.kcalLog=new CalorieLog;var app=app||{},SearchResultList=Backbone.Collection.extend({model:app.Food,query:"",loadLimit:8,loadCount:1,lastResultCount:0,isQueryExhausted:!1,lastQueryWasUnsuccessful:!1,url:function(){return"https://apibeta.nutritionix.com/v2/search?q="+this.query+"&limit="+Math.min(50,this.loadLimit*this.loadCount)+"&offset=0&appId=eb3bbaeb&appKey=4c8398b6c27e2dc907348213956bc02f"},parse:function(e){return e.results&&e.results.length?e.results:(e.errors&&e.errors.length&&e.errors[0].message&&this.trigger("error:search",e.errors[0].message),[])},search:function(e){e!==this.query&&""!==e&&(this.isQueryExhausted=!1,this.lastResultCount=0,this.query=e,this.loadCount=1,this.fetch({success:function(){this.trigger("success:loadresults")}.bind(this),error:function(){this.trigger("error:loadresults")}.bind(this)}))},loadNextSet:function(){return this.isQueryExhausted?!1:this.length!==this.lastResultCount||this.lastQueryWasUnsuccessful?(this.lastResultCount=this.length,this.loadLimit*this.loadCount>=50?!1:(this.loadCount++,this.fetch({success:function(){this.lastQueryWasUnsuccessful=!1,this.trigger("success:loadresults")}.bind(this),error:function(){this.loadCount--,this.lastQueryWasUnsuccessful=!0,this.trigger("error:loadresults")}.bind(this)}),!0)):(this.isQueryExhausted=!0,!1)}});app.searchResults=new SearchResultList;var app=app||{},PageSwapper=Backbone.Router.extend({routes:{"*page":"swapPage"},swapPage:function(e){e&&(e=e.trim()),app.page=e||"search",app.appView&&app.appView.trigger("pageswap")}});app.pageRouter=new PageSwapper;var app=app||{};app.AppView=Backbone.View.extend({el:"#health-tracker-app",events:{click:"handleClick"},initialize:function(){app.foods.fetch(),app.kcalLog.fetch(),this.searchView=new app.SearchView,this.trackersView=new app.TrackersView,this.timelineView=new app.TimelineView,this.detailsPanelView=new app.DetailsPanelView,this.logEntryView=new app.LogEntryView,this.on("pageswap",this.swapView),this.on("opendetails",this.openDetails),this.on("closedetails",this.closeDetails),this.on("openlogentry",this.openLogEntry),this.on("closelogentry",this.closeLogEntry),this.detailsPanelView.$el.click(this.closeLogEntry.bind(this)),this.logEntryView.$el.click(this.closeDetailsPopup.bind(this))},swapView:function(){this.updateNavBar(),"trackers"===app.page?this.openTrackersView():"timeline"===app.page?this.openTimelineView():this.openSearchView()},updateNavBar:function(){this.$(".page-link").removeClass("selected").filter('[href="#/'+(app.page||"search")+'"]').addClass("selected")},openSearchView:function(){this.searchView.clearSearchResults(),this.searchView.$el.removeClass("hidden"),this.trackersView.$el.addClass("hidden"),this.timelineView.$el.addClass("hidden")},openTrackersView:function(){this.trackersView.render(),this.trackersView.$el.removeClass("hidden"),this.searchView.$el.addClass("hidden"),this.timelineView.$el.addClass("hidden")},openTimelineView:function(){this.timelineView.open(),this.timelineView.$el.removeClass("hidden"),this.searchView.$el.addClass("hidden"),this.trackersView.$el.addClass("hidden"),this.timelineView.renderChart()},openDetails:function(e){try{this.detailsPanelView.open(e),this.closeLogEntry(),this.detailsPanelView.$el.removeClass("hidden")}catch(t){console.error(t)}},closeDetails:function(){this.detailsPanelView.$el.addClass("hidden")},closeDetailsPopup:function(){"absolute"===this.detailsPanelView.$el.css("position")&&this.closeDetails()},openLogEntry:function(e){try{this.logEntryView.open(e),this.closeDetailsPopup(),this.logEntryView.$el.removeClass("hidden")}catch(t){console.error(t)}},closeLogEntry:function(){this.logEntryView.$el.addClass("hidden")},handleClick:function(){this.closeDetailsPopup(),this.closeLogEntry()}});var app=app||{};app.AutoResultView=Backbone.View.extend({tagName:"option",render:function(){return this.$el.attr("value",this.model.attributes.text),this}});var app=app||{};app.DayCalorieTotalView=Backbone.View.extend({tagName:"div",template:_.template($("#calories-history-item-template").html()),events:{click:"openDetails"},initialize:function(e,t){this.date=new Date(e),this.calories=t,this.$el.addClass("calories-history-item")},render:function(){return this.$el.html(this.template({date:this.date,calories:this.calories})),this},openDetails:function(e){app.appView.trigger("opendetails",{format:"day",date:this.date}),e.stopPropagation()}});var app=app||{};app.DetailsPanelView=Backbone.View.extend({el:"#details-panel",foodTemplate:_.template($("#food-calories-history-template").html()),dayTemplate:_.template($("#day-calories-history-template").html()),events:{click:"preventClose","click #details-panel-close":"close"},initialize:function(){this.$caloriesHistory=this.$("#calories-history"),this.listenTo(app.kcalLog,"add",this.render),this.listenTo(app.kcalLog,"sort",this.render),this.listenTo(app.kcalLog,"remove",this.render),this.options=null},open:function(e){this.options=e,this.render()},render:function(){var e=this.options;if(e){var t,a;if("food"===e.format){var i=e.model,s=(new Date).toDateString();t=i.getLogData(),a={name:i.get("item_name"),image:i.get("thumbnail"),totalCalories:t.totalCalories,todayCalories:t.kcalsByDate[s]||0},this.$caloriesHistory.html(this.foodTemplate(a))}else{if("day"!==e.format)throw new Error("Unrecognized details panel format: "+e.format||"undefined");var o=e.date;t=app.kcalLog.getData({startDate:o,endDate:o}),a={date:o.toDateString(),calories:t.totalCalories},this.$caloriesHistory.html(this.dayTemplate(a))}var n=this.$("#history-list");return t.results.length?void t.results.forEach(function(e){var t=new app.HistoryItemView({model:e});n.append(t.render().el)}):void n.html($("<p>No entries found.</p>"))}},preventClose:function(e){e.stopPropagation()},close:function(){this.options=null,app.appView.trigger("closedetails")}});var app=app||{};app.FoodResultView=Backbone.View.extend({tagName:"div",template:_.template($("#food-result-template").html()),events:{"click .food-result-title":"openDetails","click .food-result-thumbnail":"openDetails","click .track-food-button.untracked":"trackStats","click .track-food-button.tracked":"stopTracking","click .new-log-entry-button":"createLogEntry"},initialize:function(){this.$el.addClass("food-result"),this.listenTo(app.foods,"add",this.refreshAfterTracking);var e=this.model.get("resource_id"),t=app.foods.get(e);t&&this.listenTo(t,"logupdate",this.render)},render:function(){var e=this.model.attributes,t=app.foods.get(e.resource_id)?!0:!1,a=new Date;a.setDate(a.getDate()-7);var i=this.model.getLogData({startDate:a}).totalCalories,s={item_name:e.item_name,brand_name:e.brand_name,thumbnail:e.thumbnail,nutrient_value:e.nutrient_value,nutrient_uom:e.nutrient_uom,serving_qty:e.serving_qty,serving_uom:e.serving_uom,resource_id:e.resource_id,isTracking:t,weekCalCount:i};return this.$el.html(this.template(s)),this},openDetails:function(e){app.foods.get(this.model.get("resource_id"))&&(app.appView.trigger("opendetails",{format:"food",model:this.model}),e.stopPropagation())},refreshAfterTracking:function(e){e.get("resource_id")===this.model.get("resource_id")&&this.render()},trackStats:function(e){if(!app.foods.get(this.model.get("resource_id"))){var t=app.foods.create(this.model.attributes);this.listenTo(t,"logupdate",this.render),e.stopPropagation()}},stopTracking:function(e){var t="Are you sure you want to delete all data for "+this.model.get("item_name")+"?";if(window.confirm(t)){var a=this.model.get("resource_id");app.foods.filter(function(e){return e.get("resource_id")===a},this).forEach(function(e){this.stopListening(e),e.destroy()},this),app.kcalLog.where({resourceId:a}).forEach(function(e){e.destroy()}),this.render()}else e.stopPropagation()},createLogEntry:function(e){app.foods.get(this.model.get("resource_id"))&&(app.appView.trigger("openlogentry",{action:"new",food:this.model}),e.stopPropagation())}});var app=app||{};app.HistoryItemView=Backbone.View.extend({tagName:"div",template:_.template($("#calories-history-item-template").html()),events:{click:"editLogEntry"},initialize:function(){this.$el.addClass("calories-history-item"),this.food=app.foods.get(this.model.get("resourceId"))},render:function(){var e=this.food,t=this.model,a={name:e.get("item_name"),brandName:e.get("brand_name"),calories:t.get("kcalCount"),date:new Date(t.get("date"))};return this.$el.html(this.template(a)),this},editLogEntry:function(e){app.appView.trigger("openlogentry",{action:"edit",entry:this.model}),e.stopPropagation()}});var app=app||{};app.LogEntryView=Backbone.View.extend({el:"#log-entry-form-container",template:_.template($("#log-entry-form-template").html()),events:{click:"preventClose","click #log-entry-form-submit":"submit","click #log-entry-form-delete":"delete","click #log-entry-form-close":"close","change #food-amount-input":"handleFoodAmountChange","change #food-unit-select":"handleFoodUnitChange","input #food-amount-input":"handleFoodAmountInput","input #food-consumption-date-input":"handleDateInput"},initialize:function(){this.$logEntryForm=this.$("#log-entry-form"),this.action=null,this.entry=null,this.food=null,this.foodAmount=null,this.disableServings=!1,this.selectedUnit="kcal",this.errors={foodAmount:!1,date:!1}},open:function(e){var t,a=e.action;if("new"===a)this.entry=null,t=this.food=e.food,this.foodAmount=null;else{if("edit"!==a)throw new Error("Unrecognized log entry form action: "+e.action||"undefined");var i=this.entry=e.entry;t=this.food=app.foods.get(i.get("resourceId"));var s=i.get("kcalCount");"serving"===this.selectedUnit?this.foodAmount=s/t.get("nutrient_value"):this.foodAmount=s}if(this.action=a,t.get("serving_qty")&&t.get("nutrient_value")&&"kcal"===t.get("nutrient_uom"))this.disableServings=!1;else{this.disableServings=!0;var o=this.foodAmount;o&&"serving"===this.selectedUnit&&(this.selectedUnit="kcal",this.foodAmount=o*t.get("nutrient_value"))}this.render()},render:function(){var e=this.entry,t=this.food,a={itemName:t.get("item_name"),action:e?"edit":"new",selectedUnit:this.selectedUnit,disableServings:this.disableServings,servingQty:t.get("serving_qty"),servingUom:t.get("serving_uom"),date:e?new Date(e.get("date")):new Date};this.$logEntryForm.html(this.template(a)),this.renderFoodAmountInput(),this.renderServingSize(),this.renderErrors()},renderFoodAmountInput:function(){var e=this.foodAmount,t=e?parseFloat(e).toFixed(1):"";this.$("#food-amount-input").val(t)},renderServingSize:function(){var e=this.$("#serving-size-notice");return"serving"===this.selectedUnit?void e.removeClass("hidden"):void e.addClass("hidden")},renderErrors:function(){var e=this.errors,t=this.$("#log-entry-error");e.foodAmount||e.date?t.removeClass("hidden"):t.addClass("hidden");var a=this.$("#food-amount-input"),i=this.$("#food-consumption-date-input");e.foodAmount?a.addClass("has-error"):a.removeClass("has-error"),e.date?i.addClass("has-error"):i.removeClass("has-error")},preventClose:function(e){e.stopPropagation()},submit:function(){var e=this.$("#food-amount-input").get(0),t=this.$("#food-unit-select").get(0),a=this.$("#food-consumption-date-input").get(0),i=this.errors={foodAmount:!e.checkValidity(),date:!a.checkValidity()};if(i.foodAmount||i.date)return void this.renderErrors();var s,o=this.food,n=this.foodAmount,r=t.value;s="serving"===r?n*o.get("nutrient_value"):n;var l=a.value.split("-"),d=new Date;d.setYear(l[0]),d.setMonth(l[1]-1),d.setDate(l[2]);var h=this.entry;h?(h.setCalorieCount(s),h.setDate(d)):app.kcalLog.create({resourceId:o.get("resource_id"),kcalCount:s,date:d}),o.trigger("logupdate"),this.close()},"delete":function(){var e=this.entry,t="Are you sure you want to delete an entry for "+e.get("kcalCount")+" Calories on "+new Date(e.get("date")).toDateString()+"?";window.confirm(t)&&(e.destroy(),this.close())},close:function(){app.appView.trigger("closelogentry")},handleFoodAmountChange:function(e){this.foodAmount=parseFloat(e.target.value)},handleFoodUnitChange:function(e){var t=this.selectedUnit=e.target.value;if("serving"===t&&this.disableServings)return void(this.selectedUnit="kcal");var a=this.food,i=a.get("nutrient_value");if(a.get("serving_qty")&&i){var s=this.foodAmount;isNaN(s)||("serving"===t?this.foodAmount=s/i:this.foodAmount=s*i)}else{var o=this.entry;o&&"kcal"===t?this.foodAmount=o.get("kcalCount"):this.foodAmount=null}this.renderFoodAmountInput(),this.renderServingSize()},handleFoodAmountInput:function(e){var t=this.errors;t.foodAmount&&e.target.checkValidity()&&(t.foodAmount=!1,this.renderErrors())},handleDateInput:function(e){var t=this.errors;t.date&&e.target.checkValidity()&&(t.date=!1,this.renderErrors())}});var app=app||{};app.SearchView=Backbone.View.extend({el:"#search",events:{"input #searchbar":"autocompleteOnInput","keypress #searchbar":"searchOnEnter","click #search-button":"searchOnEnter"},initialize:function(){this.$searchbar=this.$("#searchbar"),this.$autoResults=this.$("#auto-results"),this.$searchResults=this.$("#search-results"),this.loadingFrames=["Loading","Loading .","Loading . .","Loading . . ."],this.$searchResults.scroll(this.loadMoreOnScrollEnd.bind(this)),this.listenTo(app.searchResults,"success:loadresults",this.handleResultsLoadSuccess),this.listenTo(app.searchResults,"error:loadresults",this.handleResultsLoadError),this.listenTo(app.autoResults,"sync",this.updateAutocomplete),this.listenTo(app.searchResults,"sync",this.retrieveSearchResults),this.clearSearchResults()},updateAutocomplete:function(){var e=this.$autoResults;e.html(""),app.autoResults.each(function(t){var a=new app.AutoResultView({model:t});e.append(a.render().el)})},retrieveSearchResults:function(){var e=this.$searchResults;e.html(""),app.searchResults.length?app.searchResults.each(function(t){var a=new app.FoodResultView({model:t});e.append(a.render().el)}):this.displayNoneFoundMessage()},displayNoneFoundMessage:function(){this.$searchResults.html($('<p class="none-found">No results found.</p>'))},autocompleteOnInput:function(){var e=this.$searchbar.val().trim();e&&app.autoResults.autocomplete(e)},searchOnEnter:function(e){if("click"===e.type||e.which===ENTER_KEY){this.$searchbar.blur();var t=this.$searchbar.val().trim();t&&(app.searchResults.search(t),this.displayLoadingIndicator())}},loadMoreOnScrollEnd:function(e){this.scrollTimeout&&clearTimeout(this.scrollTimeout),this.scrollTimeout=setTimeout(this.loadMoreSearchResults.bind(this),250)},loadMoreSearchResults:function(){var e=this.$searchResults[0],t=e.scrollTop,a=e.scrollHeight-e.offsetHeight;t>=a-100&&app.searchResults.loadNextSet()&&this.displayLoadingIndicator()},clearSearchResults:function(){this.$searchbar.val(""),this.displayNoneFoundMessage()},handleResultsLoadSuccess:function(){this.hideLoadingIndicator()},handleResultsLoadError:function(){this.hideLoadingIndicator();var e='<div class="load-error-container"><div id="load-error" class="load-error">We\'re having trouble fetching results . . .</div></div>';this.$searchResults.append(e),setTimeout(function(){this.$("#load-error").parent().remove()},2500)},displayLoadingIndicator:function(){var e='<div class="loading-container"><div id="loading" class="loading">'+this.loadingFrames[0]+"</div></div>";this.$searchResults.append(e),this.currentLoadingFrame=0,this.loadingInterval=setInterval(this.progressLoadingAnimation.bind(this),100)},progressLoadingAnimation:function(){this.currentLoadingFrame++,4===this.currentLoadingFrame&&(this.currentLoadingFrame=0),this.$("#loading").text(this.loadingFrames[this.currentLoadingFrame])},hideLoadingIndicator:function(){var e=$("#loading");e.length&&e.parent().remove(),this.loadingInterval&&clearInterval(this.loadingInterval)}});var app=app||{};app.TimelineView=Backbone.View.extend({el:"#timeline",events:{"click #previous-month":"openPreviousMonth","click #next-month":"openNextMonth"},initialize:function(){this.MONTH_NAMES=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],this.$dailyCalorieTotals=this.$("#daily-calorie-totals"),this.listenTo(app.kcalLog,"add",this.updateIfOpen),this.listenTo(app.kcalLog,"sort",this.updateIfOpen),this.listenTo(app.kcalLog,"remove",this.updateIfOpen),this.logData=null,this.chartDataList=null,this.monthBounds=null;var e=null;$(window).resize(function(){clearTimeout(e),this.isOpen()&&(e=setTimeout(this.render.bind(this),200))}.bind(this))},open:function(e){e=e||new Date;var t=e.getFullYear(),a=e.getMonth();this.monthBounds={startDate:new Date(t,a,1),endDate:new Date(t,a+1,0)},this.fetchData(),this.render()},fetchData:function(){var e=this.logData=app.kcalLog.getData(this.monthBounds),t=e.kcalsByDate,a=this.chartDataList=[],i=this.monthBounds,s=new Date(i.startDate),o=new Date(i.endDate);for(o.setDate(o.getDate()+1);o>s;){var n=s.toDateString();t[n]?a.push({date:new Date(n),Calories:t[n]}):a.push({date:new Date(s),Calories:0}),s.setDate(s.getDate()+1)}},openPreviousMonth:function(){var e=new Date(this.monthBounds.startDate);e.setMonth(e.getMonth()-1),this.open(e)},openNextMonth:function(){var e=new Date(this.monthBounds.startDate);e.setMonth(e.getMonth()+1),this.open(e)},updateIfOpen:function(){this.isOpen()&&this.open(this.monthBounds.startDate)},render:function(){this.renderChart(),this.renderDailyTotals()},renderChart:function(){var e=this.logData.totalCalories,t=this.monthBounds,a=this.MONTH_NAMES[t.startDate.getMonth()],i=t.startDate.getFullYear();MG.data_graphic({title:a+" "+i+": "+e.toLocaleString()+" Total Cal",data:this.chartDataList,target:"#timeline-chart",x_accessor:"date",y_accessor:"Calories",mouseover_align:"center",y_rollover_format:function(e){return e.Calories.toLocaleString()+" Cal"},buffer:1,left:35,right:15,bottom:30,top:60,full_width:this.isOpen(),full_height:this.isOpen()})},renderDailyTotals:function(){if($dailyCalorieTotals=this.$dailyCalorieTotals,$dailyCalorieTotals.html(""),!this.logData.totalCalories)return void $dailyCalorieTotals.html($('<p class="none-found">No entries found.</p>'));var e=!1,t=0;this.chartDataList.forEach(function(a){if(!a.Calories)return void(e=!0);e&&t&&$dailyCalorieTotals.append($("<hr>"));var i=new app.DayCalorieTotalView(a.date,a.Calories);$dailyCalorieTotals.append(i.render().el),e=!1,t++})},isOpen:function(){return!this.$el.hasClass("hidden")}});var app=app||{};app.TrackersView=Backbone.View.extend({el:"#trackers",initialize:function(){this.$trackerList=this.$("#tracker-list"),this.listenTo(app.foods,"sort",this.render),this.listenTo(app.foods,"remove",this.render)},render:function(){var e=this.$trackerList;e.html(""),app.foods.length?app.foods.each(function(t){var a=new app.FoodResultView({model:t});e.append(a.render().el)}):e.append($('<p class="none-found">No foods tracked.</p>'))}});var app=app||{},ENTER_KEY=13;$(function(){app.appView=new app.AppView,Backbone.history.start()});